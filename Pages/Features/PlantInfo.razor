@page "/display-image"

@using Microsoft.AspNetCore.Http
@using System.IO

@inject Microsoft.AspNetCore.Http.ISession Session
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation

<h1>Display Image</h1>

<InputFile @bind="@selectedFile" />

<button @onclick="@SubmitImage">Submit</button>

@if (imageUrl != null)
{
    <img src="@Uri.EscapeUriString(imageUrl)" />
}

@code {
    private Microsoft.AspNetCore.Http.IFormFile selectedFile;
    private string imageUrl;

    protected override void OnInitialized()
    {
        // Check if the selected file is stored in the session state
        var selectedFileBytes = Session.Get("selected-file");
        if (selectedFileBytes != null)
        {
            // Get the file name and content type from the session state
            var fileName = Session.GetString("selected-file-name");
            var contentType = Session.GetString("selected-file-content-type");

            // Create a new IFormFile instance from the saved data
            selectedFile = new FormFile(new MemoryStream(selectedFileBytes), 0, selectedFileBytes.Length, fileName, fileName);

            // Generate the URL of the saved file
            imageUrl = Navigation.ToAbsoluteUri(Navigation.Uri).ToString();
        }
    }

    private async Task SubmitImage()
    {
        if (selectedFile != null)
        {
            // Save the selected file to the session state
            var memoryStream = new MemoryStream();
            await selectedFile.CopyToAsync(memoryStream);
            var selectedFileBytes = memoryStream.ToArray();
            Session.Set("selected-file", selectedFileBytes);
            Session.SetString("selected-file-name", selectedFile.FileName);
            Session.SetString("selected-file-content-type", selectedFile.ContentType);

            // Generate the URL of the saved file
            imageUrl = Navigation.ToAbsoluteUri(Navigation.Uri).ToString();
        }
    }
}
